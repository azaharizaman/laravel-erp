<!DOCTYPE html>
<html>
<head>
<title>PRD01-SUB01-MULTITENANCY.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="prd01-sub01-multi-tenancy-system">PRD01-SUB01: Multi-Tenancy System</h1>
<p><strong>Master PRD:</strong> <a href="../PRD01-MVP.md">../PRD01-MVP.md</a><br>
<strong>Feature Module Category:</strong> Mandatory Feature Modules - Core Infrastructure<br>
<strong>Related Sub-PRDs:</strong> PRD01-SUB02 (Authentication), PRD01-SUB03 (Audit Logging), PRD01-SUB05 (Settings Management), PRD01-SUB22 (Notifications &amp; Events), PRD01-SUB23 (API Gateway)<br>
<strong>Composer Package:</strong> <code>azaharizaman/erp-multitenancy</code><br>
<strong>Version:</strong> 1.0.0<br>
<strong>Status:</strong> Draft<br>
<strong>Created:</strong> November 11, 2025</p>
<hr>
<h2 id="executive-summary">Executive Summary</h2>
<p>The Multi-Tenancy System provides <strong>tenant isolation infrastructure enabling secure data segregation across organizations</strong> with configurable settings and middleware-based context resolution. This is a mandatory feature module that forms the foundation of the Laravel ERP's ability to serve multiple organizations from a single application instance while maintaining complete data isolation and security boundaries.</p>
<h3 id="purpose">Purpose</h3>
<p>The Multi-Tenancy System solves the critical problem of <strong>secure multi-organization data isolation</strong> in a shared infrastructure. It enables:</p>
<ol>
<li><strong>Cost-Effective SaaS Delivery:</strong> Multiple organizations share infrastructure while maintaining complete data privacy</li>
<li><strong>Resource Efficiency:</strong> Reduced operational overhead through shared application code and optimized resource utilization</li>
<li><strong>Horizontal Scalability:</strong> Support for thousands of concurrent tenants without architectural limitations</li>
<li><strong>Administrative Flexibility:</strong> Centralized management with per-tenant configuration and impersonation capabilities</li>
</ol>
<h3 id="scope">Scope</h3>
<p><strong>Included in this Feature Module:</strong></p>
<ul>
<li>✅ Tenant Model and database schema</li>
<li>✅ Tenant context resolution middleware</li>
<li>✅ Automatic tenant scoping for Eloquent models</li>
<li>✅ Tenant-scoped caching mechanisms</li>
<li>✅ Tenant impersonation with audit controls</li>
<li>✅ Tenant configuration management</li>
<li>✅ Cross-tenant data exposure prevention</li>
<li>✅ Tenant lifecycle management (create, suspend, archive)</li>
</ul>
<p><strong>Excluded from this Feature Module:</strong></p>
<ul>
<li>❌ User authentication (handled by SUB02)</li>
<li>❌ Activity logging (handled by SUB03)</li>
<li>❌ Settings storage (handled by SUB05)</li>
<li>❌ Event broadcasting (handled by SUB22)</li>
<li>❌ API gateway logic (handled by SUB23)</li>
</ul>
<h3 id="dependencies">Dependencies</h3>
<p><strong>Mandatory Dependencies:</strong></p>
<ul>
<li>Laravel Framework v12.x</li>
<li>PHP ≥ 8.2</li>
<li>SQL database (PostgreSQL or MySQL)</li>
<li>Redis or Memcached for caching</li>
</ul>
<p><strong>Feature Module Dependencies:</strong></p>
<ul>
<li><strong>None</strong> - This is a foundational feature module with no dependencies on other optional feature modules</li>
</ul>
<h3 id="composer-package-information">Composer Package Information</h3>
<ul>
<li><strong>Package Name:</strong> <code>azaharizaman/erp-multitenancy</code></li>
<li><strong>Namespace:</strong> <code>Azaharizaman\Erp\Multitenancy</code></li>
<li><strong>Monorepo Location:</strong> <code>/packages/multitenancy/</code></li>
<li><strong>Installation:</strong> <code>composer require azaharizaman/erp-multitenancy</code> (post v1.0 release)</li>
</ul>
<hr>
<h2 id="requirements">Requirements</h2>
<blockquote>
<p><strong>Note:</strong> These requirements are derived from Master PRD Section F.2.3 - PRD01-SUB01 (Multi-Tenancy System). For complete traceability and context, refer to the <a href="../PRD01-MVP.md#f23-requirements-by-sub-prd">Master PRD Requirements Table</a>.</p>
</blockquote>
<h3 id="functional-requirements-fr">Functional Requirements (FR)</h3>
<table>
<thead>
<tr>
<th>Requirement ID</th>
<th>Description</th>
<th>Priority</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>FR-MT-001</strong></td>
<td>Implement a <strong>Tenant Model</strong> to represent isolated entities with unique identifiers, names, domains, and status</td>
<td>High</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>FR-MT-002</strong></td>
<td>Ensure strict <strong>Tenant Data Isolation</strong> by scoping all database and cache operations per tenant using global scopes and middleware</td>
<td>High</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>FR-MT-003</strong></td>
<td>Establish <strong>Tenant Context middleware</strong> to resolve and inject active tenant context from authenticated user, subdomain, or header</td>
<td>High</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>FR-MT-004</strong></td>
<td>Support <strong>tenant-specific configuration</strong> with cascading settings (system → tenant → user)</td>
<td>High</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>FR-MT-005</strong></td>
<td>Provide <strong>tenant lifecycle management</strong> (create, activate, suspend, archive) with status transitions</td>
<td>High</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>FR-MT-006</strong></td>
<td>Allow <strong>Tenant Impersonation</strong> for administrative support under strict auditing control with session management and reason tracking</td>
<td>Medium</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>FR-MT-007</strong></td>
<td>Implement <strong>tenant-scoped caching</strong> with automatic cache key prefixing per tenant</td>
<td>Medium</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="business-rules-br">Business Rules (BR)</h3>
<table>
<thead>
<tr>
<th>Rule ID</th>
<th>Description</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>BR-MT-001</strong></td>
<td>Each tenant MUST have a unique identifier (UUID) that never changes throughout the tenant lifecycle</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>BR-MT-002</strong></td>
<td>Tenant domain names MUST be unique across the entire system to prevent routing conflicts</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>BR-MT-003</strong></td>
<td>Tenant status can be: ACTIVE, SUSPENDED, ARCHIVED - only ACTIVE tenants can access the system</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="data-requirements-dr">Data Requirements (DR)</h3>
<table>
<thead>
<tr>
<th>Requirement ID</th>
<th>Description</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DR-MT-001</strong></td>
<td>Tenants table MUST include: id (UUID), name, domain, status (enum), configuration (encrypted JSON), timestamps, soft deletes</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>DR-MT-002</strong></td>
<td>All tenant-scoped models MUST include <code>tenant_id</code> foreign key with composite indexes for optimal query performance</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="security-requirements-sr">Security Requirements (SR)</h3>
<table>
<thead>
<tr>
<th>Requirement ID</th>
<th>Description</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SR-MT-001</strong></td>
<td>Prevent <strong>cross-tenant data exposure</strong> through Eloquent global scopes on all tenant-scoped models</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>SR-MT-002</strong></td>
<td>Tenant resolution MUST fail-safe: if tenant cannot be determined, request MUST be rejected with 403 Forbidden</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>SR-MT-003</strong></td>
<td><strong>Encrypt tenant-specific configurations</strong> and secrets using Laravel's encryption facilities</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>SR-MT-004</strong></td>
<td>Log all <strong>tenant impersonation sessions</strong> with impersonator identity, target tenant, reason, and timestamp for compliance auditing</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="performance-requirements-pr">Performance Requirements (PR)</h3>
<table>
<thead>
<tr>
<th>Requirement ID</th>
<th>Target</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PR-MT-001</strong></td>
<td>Tenant resolution and context loading must complete in <strong>&lt; 100ms</strong> using Redis caching</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>PR-MT-002</strong></td>
<td>Database queries MUST automatically include <code>tenant_id</code> in WHERE clauses to leverage composite indexes</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="scalability-requirements-scr">Scalability Requirements (SCR)</h3>
<table>
<thead>
<tr>
<th>Requirement ID</th>
<th>Description</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SCR-MT-001</strong></td>
<td>Support <strong>10,000+ concurrent active tenants</strong> without performance degradation</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>SCR-MT-002</strong></td>
<td>Tenant context caching MUST distribute across Redis cluster for high availability</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="architecture-requirements-arch">Architecture Requirements (ARCH)</h3>
<table>
<thead>
<tr>
<th>Requirement ID</th>
<th>Description</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ARCH-MT-001</strong></td>
<td>Use <strong>middleware-based tenant resolution</strong> to inject context into application lifecycle</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>ARCH-MT-002</strong></td>
<td>Implement Eloquent <strong>global scope trait</strong> (<code>BelongsToTenant</code>) for automatic tenant filtering</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<h3 id="event-requirements-ev">Event Requirements (EV)</h3>
<table>
<thead>
<tr>
<th>Event ID</th>
<th>Event Name</th>
<th>Trigger</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>EV-MT-001</strong></td>
<td><code>TenantCreatedEvent</code></td>
<td>When new tenant is provisioned</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>EV-MT-002</strong></td>
<td><code>TenantSuspendedEvent</code></td>
<td>When tenant status changes to SUSPENDED</td>
<td>Planned</td>
</tr>
<tr>
<td><strong>EV-MT-003</strong></td>
<td><code>TenantImpersonationStartedEvent</code></td>
<td>When admin begins tenant impersonation session</td>
<td>Planned</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="technical-specifications">Technical Specifications</h2>
<h3 id="database-schema">Database Schema</h3>
<p><strong>Tenants Table:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tenants (
    <span class="hljs-keyword">id</span> <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">domain</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'active'</span>,
    configuration <span class="hljs-built_in">TEXT</span>,  <span class="hljs-comment">-- Encrypted JSON</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span>,
    deleted_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-literal">NULL</span>,
    
    <span class="hljs-keyword">INDEX</span> idx_tenants_domain (<span class="hljs-keyword">domain</span>),
    <span class="hljs-keyword">INDEX</span> idx_tenants_status (<span class="hljs-keyword">status</span>),
    <span class="hljs-keyword">INDEX</span> idx_tenants_created (created_at)
);
</div></code></pre>
<p><strong>Status Enum Values:</strong></p>
<ul>
<li><code>active</code> - Tenant can access all system features</li>
<li><code>suspended</code> - Tenant access temporarily disabled</li>
<li><code>archived</code> - Tenant read-only for compliance</li>
</ul>
<p><strong>Configuration JSON Structure:</strong></p>
<pre class="hljs"><code><div>{
    <span class="hljs-attr">"settings"</span>: {
        <span class="hljs-attr">"timezone"</span>: <span class="hljs-string">"UTC"</span>,
        <span class="hljs-attr">"date_format"</span>: <span class="hljs-string">"Y-m-d"</span>,
        <span class="hljs-attr">"locale"</span>: <span class="hljs-string">"en"</span>
    },
    <span class="hljs-attr">"features"</span>: {
        <span class="hljs-attr">"inventory"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"accounting"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">"sales"</span>: <span class="hljs-literal">false</span>
    },
    <span class="hljs-attr">"limits"</span>: {
        <span class="hljs-attr">"max_users"</span>: <span class="hljs-number">100</span>,
        <span class="hljs-attr">"max_storage_gb"</span>: <span class="hljs-number">50</span>
    }
}
</div></code></pre>
<h3 id="api-endpoints">API Endpoints</h3>
<p>All endpoints follow <code>/api/v1/admin/tenants</code> pattern:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Purpose</th>
<th>Auth Required</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/api/v1/admin/tenants</code></td>
<td>List all tenants (paginated)</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/admin/tenants</code></td>
<td>Create new tenant</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/v1/admin/tenants/{id}</code></td>
<td>Get tenant details</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>PATCH</td>
<td><code>/api/v1/admin/tenants/{id}</code></td>
<td>Update tenant</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>DELETE</td>
<td><code>/api/v1/admin/tenants/{id}</code></td>
<td>Soft delete tenant</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/admin/tenants/{id}/suspend</code></td>
<td>Suspend tenant access</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/admin/tenants/{id}/activate</code></td>
<td>Reactivate tenant</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/admin/tenants/{id}/archive</code></td>
<td>Archive tenant</td>
<td>Yes - Admin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/admin/tenants/{id}/impersonate</code></td>
<td>Start impersonation session</td>
<td>Yes - Super Admin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/v1/admin/tenants/impersonate/stop</code></td>
<td>End impersonation session</td>
<td>Yes - Super Admin</td>
</tr>
</tbody>
</table>
<p><strong>Request/Response Examples:</strong></p>
<p><strong>Create Tenant:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// POST /api/v1/admin/tenants</span>
{
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Acme Corporation"</span>,
    <span class="hljs-attr">"domain"</span>: <span class="hljs-string">"acme"</span>,
    <span class="hljs-attr">"status"</span>: <span class="hljs-string">"active"</span>,
    <span class="hljs-attr">"configuration"</span>: {
        <span class="hljs-attr">"timezone"</span>: <span class="hljs-string">"America/New_York"</span>,
        <span class="hljs-attr">"locale"</span>: <span class="hljs-string">"en_US"</span>
    }
}

<span class="hljs-comment">// Response 201 Created</span>
{
    <span class="hljs-attr">"data"</span>: {
        <span class="hljs-attr">"id"</span>: <span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>,
        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Acme Corporation"</span>,
        <span class="hljs-attr">"domain"</span>: <span class="hljs-string">"acme"</span>,
        <span class="hljs-attr">"status"</span>: <span class="hljs-string">"active"</span>,
        <span class="hljs-attr">"created_at"</span>: <span class="hljs-string">"2025-11-11T10:00:00Z"</span>
    }
}
</div></code></pre>
<p><strong>Impersonate Tenant:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// POST /api/v1/admin/tenants/{id}/impersonate</span>
{
    <span class="hljs-attr">"reason"</span>: <span class="hljs-string">"Customer support - investigating invoice issue #12345"</span>
}

<span class="hljs-comment">// Response 200 OK</span>
{
    <span class="hljs-attr">"data"</span>: {
        <span class="hljs-attr">"session_id"</span>: <span class="hljs-string">"imp_7d8f9e0a1b2c3d4e"</span>,
        <span class="hljs-attr">"tenant_id"</span>: <span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>,
        <span class="hljs-attr">"tenant_name"</span>: <span class="hljs-string">"Acme Corporation"</span>,
        <span class="hljs-attr">"expires_at"</span>: <span class="hljs-string">"2025-11-11T11:00:00Z"</span>
    }
}
</div></code></pre>
<h3 id="events">Events</h3>
<p><strong>Domain Events Emitted by this Feature Module:</strong></p>
<table>
<thead>
<tr>
<th>Event Class</th>
<th>When Fired</th>
<th>Payload</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TenantCreatedEvent</code></td>
<td>After new tenant is successfully created</td>
<td><code>Tenant $tenant</code></td>
</tr>
<tr>
<td><code>TenantUpdatedEvent</code></td>
<td>After tenant details are modified</td>
<td><code>Tenant $tenant, array $changes</code></td>
</tr>
<tr>
<td><code>TenantSuspendedEvent</code></td>
<td>When tenant status changes to suspended</td>
<td><code>Tenant $tenant, string $reason</code></td>
</tr>
<tr>
<td><code>TenantActivatedEvent</code></td>
<td>When tenant status changes to active</td>
<td><code>Tenant $tenant</code></td>
</tr>
<tr>
<td><code>TenantArchivedEvent</code></td>
<td>When tenant is archived</td>
<td><code>Tenant $tenant</code></td>
</tr>
<tr>
<td><code>TenantDeletedEvent</code></td>
<td>When tenant is soft deleted</td>
<td><code>Tenant $tenant</code></td>
</tr>
<tr>
<td><code>TenantImpersonationStartedEvent</code></td>
<td>When admin starts impersonation</td>
<td><code>Tenant $tenant, User $impersonator, string $reason</code></td>
</tr>
<tr>
<td><code>TenantImpersonationEndedEvent</code></td>
<td>When impersonation session ends</td>
<td><code>Tenant $tenant, User $impersonator, int $duration_seconds</code></td>
</tr>
</tbody>
</table>
<p><strong>Event Usage Example:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">use</span> <span class="hljs-title">Azaharizaman</span>\<span class="hljs-title">Erp</span>\<span class="hljs-title">Multitenancy</span>\<span class="hljs-title">Events</span>\<span class="hljs-title">TenantCreatedEvent</span>;

<span class="hljs-comment">// Emit event after tenant creation</span>
event(<span class="hljs-keyword">new</span> TenantCreatedEvent($tenant));

<span class="hljs-comment">// Other modules can listen:</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InitializeTenantDataListener</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(TenantCreatedEvent $event)</span>: <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-comment">// Create default roles, permissions, settings for new tenant</span>
        <span class="hljs-keyword">$this</span>-&gt;createDefaultRoles($event-&gt;tenant);
    }
}
</div></code></pre>
<h3 id="event-listeners">Event Listeners</h3>
<p><strong>Events this Feature Module Listens To:</strong></p>
<p>This feature module does not listen to events from other modules as it is a foundational layer.</p>
<hr>
<h2 id="implementation-plans">Implementation Plans</h2>
<p><strong>Note:</strong> Implementation plans follow the naming convention <code>PLAN{number}-{action}-{component}.md</code></p>
<table>
<thead>
<tr>
<th>Plan File</th>
<th>Requirements Covered</th>
<th>Milestone</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>PLAN01-implement-multitenancy.md</td>
<td>FR-MT-001, FR-MT-002, FR-MT-003, FR-MT-006, SR-MT-001, SR-MT-002, SR-MT-003, PR-MT-001, SCR-MT-001, ARCH-MT-001, ARCH-MT-002, ARCH-MT-003, ARCH-MT-004</td>
<td>MILESTONE 1</td>
<td>Not Started</td>
</tr>
</tbody>
</table>
<p><strong>Implementation plan will be created separately using:</strong> <code>.github/prompts/create-implementation-plan.prompt.md</code></p>
<hr>
<h2 id="acceptance-criteria">Acceptance Criteria</h2>
<h3 id="functional-acceptance">Functional Acceptance</h3>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0">Tenant Model with full CRUD operations implemented</label></li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1">Tenant resolution middleware automatically resolves tenant from subdomain/header/user</label></li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2">All Eloquent models using </label><code>BelongsToTenant</code> trait automatically filter by tenant_id</li>
<li><input type="checkbox" id="checkbox3"><label for="checkbox3">Tenant impersonation works with session management and audit logging</label></li>
<li><input type="checkbox" id="checkbox4"><label for="checkbox4">Tenant status transitions (active → suspended → archived) function correctly</label></li>
<li><input type="checkbox" id="checkbox5"><label for="checkbox5">API endpoints return proper error codes for cross-tenant access attempts</label></li>
</ul>
<h3 id="performance-acceptance">Performance Acceptance</h3>
<ul>
<li><input type="checkbox" id="checkbox6"><label for="checkbox6">Tenant resolution completes in &lt; 100ms (average)</label></li>
<li><input type="checkbox" id="checkbox7"><label for="checkbox7">Redis caching reduces database queries for tenant context by 95%</label></li>
<li><input type="checkbox" id="checkbox8"><label for="checkbox8">Database indexes on tenant_id optimize query performance</label></li>
</ul>
<h3 id="security-acceptance">Security Acceptance</h3>
<ul>
<li><input type="checkbox" id="checkbox9"><label for="checkbox9">Cross-tenant data access prevented by global scopes (verified in tests)</label></li>
<li><input type="checkbox" id="checkbox10"><label for="checkbox10">Tenant configuration encrypted at rest</label></li>
<li><input type="checkbox" id="checkbox11"><label for="checkbox11">Impersonation requires explicit permission and logs all actions</label></li>
<li><input type="checkbox" id="checkbox12"><label for="checkbox12">Failed tenant resolution returns 403 Forbidden (not 404)</label></li>
</ul>
<h3 id="testing-acceptance">Testing Acceptance</h3>
<ul>
<li><input type="checkbox" id="checkbox13"><label for="checkbox13">100% unit test coverage for Tenant model and repository</label></li>
<li><input type="checkbox" id="checkbox14"><label for="checkbox14">Feature tests for all API endpoints (CRUD, suspend, activate, archive, impersonate)</label></li>
<li><input type="checkbox" id="checkbox15"><label for="checkbox15">Integration tests verify cross-tenant isolation</label></li>
<li><input type="checkbox" id="checkbox16"><label for="checkbox16">Performance tests validate &lt; 100ms tenant resolution</label></li>
<li><input type="checkbox" id="checkbox17"><label for="checkbox17">Security tests verify global scope protection</label></li>
</ul>
<h3 id="documentation-acceptance">Documentation Acceptance</h3>
<ul>
<li><input type="checkbox" id="checkbox18"><label for="checkbox18">API documentation complete (OpenAPI/Swagger)</label></li>
<li><input type="checkbox" id="checkbox19"><label for="checkbox19">Tenant resolution strategies documented with examples</label></li>
<li><input type="checkbox" id="checkbox20"><label for="checkbox20">Impersonation workflow documented for support teams</label></li>
<li><input type="checkbox" id="checkbox21"><label for="checkbox21">Migration guide for adding tenant_id to existing models</label></li>
<li><input type="checkbox" id="checkbox22"><label for="checkbox22">PHPDoc complete for all public classes and methods</label></li>
</ul>
<h3 id="code-quality-acceptance">Code Quality Acceptance</h3>
<ul>
<li><input type="checkbox" id="checkbox23"><label for="checkbox23">Code passes Laravel Pint formatting</label></li>
<li><input type="checkbox" id="checkbox24"><label for="checkbox24">PHPStan level 5 compliance</label></li>
<li><input type="checkbox" id="checkbox25"><label for="checkbox25">Code review completed and approved</label></li>
<li><input type="checkbox" id="checkbox26"><label for="checkbox26">No direct SQL queries (use Eloquent/Query Builder)</label></li>
<li><input type="checkbox" id="checkbox27"><label for="checkbox27">All files include </label><code>declare(strict_types=1);</code></li>
</ul>
<hr>
<h2 id="testing-strategy">Testing Strategy</h2>
<h3 id="unit-tests">Unit Tests</h3>
<p><strong>Test Coverage Areas:</strong></p>
<ul>
<li>Tenant Model CRUD operations</li>
<li>Tenant status transitions and validation</li>
<li>Tenant configuration encryption/decryption</li>
<li>BelongsToTenant trait functionality</li>
<li>Tenant repository methods</li>
<li>Helper functions (getCurrentTenant(), etc.)</li>
</ul>
<p><strong>Test Examples:</strong></p>
<pre class="hljs"><code><div>test(<span class="hljs-string">'tenant model has correct fillable attributes'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant = <span class="hljs-keyword">new</span> Tenant();
    expect($tenant-&gt;getFillable())-&gt;toContain(<span class="hljs-string">'name'</span>, <span class="hljs-string">'domain'</span>, <span class="hljs-string">'status'</span>, <span class="hljs-string">'configuration'</span>);
});

test(<span class="hljs-string">'tenant configuration is encrypted when saved'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant = Tenant::factory()-&gt;create([
        <span class="hljs-string">'configuration'</span> =&gt; [<span class="hljs-string">'key'</span> =&gt; <span class="hljs-string">'value'</span>]
    ]);
    
    $raw = DB::table(<span class="hljs-string">'tenants'</span>)-&gt;find($tenant-&gt;id);
    expect($raw-&gt;configuration)-&gt;not-&gt;toBe(<span class="hljs-string">'{"key":"value"}'</span>); <span class="hljs-comment">// Should be encrypted</span>
    expect($tenant-&gt;configuration)-&gt;toBe([<span class="hljs-string">'key'</span> =&gt; <span class="hljs-string">'value'</span>]); <span class="hljs-comment">// Should decrypt on access</span>
});

test(<span class="hljs-string">'BelongsToTenant trait automatically adds tenant_id on create'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant = Tenant::factory()-&gt;create();
    TenantContext::set($tenant);
    
    $model = <span class="hljs-keyword">new</span> TenantScopedModel([<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Test'</span>]);
    $model-&gt;save();
    
    expect($model-&gt;tenant_id)-&gt;toBe($tenant-&gt;id);
});
</div></code></pre>
<h3 id="feature-tests">Feature Tests</h3>
<p><strong>Test Coverage Areas:</strong></p>
<ul>
<li>API endpoint responses (status codes, data structure)</li>
<li>Tenant CRUD operations via API</li>
<li>Tenant lifecycle (create → active → suspended → archived)</li>
<li>Impersonation flow (start, use, stop)</li>
<li>Cross-tenant access prevention</li>
<li>Middleware tenant resolution</li>
</ul>
<p><strong>Test Examples:</strong></p>
<pre class="hljs"><code><div>test(<span class="hljs-string">'can create tenant via API'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $admin = User::factory()-&gt;admin()-&gt;create();
    
    $response = <span class="hljs-keyword">$this</span>-&gt;actingAs($admin, <span class="hljs-string">'sanctum'</span>)
        -&gt;postJson(<span class="hljs-string">'/api/v1/admin/tenants'</span>, [
            <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Test Corp'</span>,
            <span class="hljs-string">'domain'</span> =&gt; <span class="hljs-string">'testcorp'</span>,
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'active'</span>
        ]);
    
    $response-&gt;assertCreated()
        -&gt;assertJsonStructure([<span class="hljs-string">'data'</span> =&gt; [<span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'domain'</span>, <span class="hljs-string">'status'</span>]]);
});

test(<span class="hljs-string">'cannot access another tenant data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant1 = Tenant::factory()-&gt;create();
    $tenant2 = Tenant::factory()-&gt;create();
    $user = User::factory()-&gt;for($tenant1)-&gt;create();
    
    $item = Item::factory()-&gt;for($tenant2)-&gt;create();
    
    <span class="hljs-keyword">$this</span>-&gt;actingAs($user, <span class="hljs-string">'sanctum'</span>)
        -&gt;getJson(<span class="hljs-string">"/api/v1/items/{$item-&gt;id}"</span>)
        -&gt;assertForbidden();
});

test(<span class="hljs-string">'impersonation session expires after timeout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $admin = User::factory()-&gt;superAdmin()-&gt;create();
    $tenant = Tenant::factory()-&gt;create();
    
    <span class="hljs-comment">// Start impersonation</span>
    $response = <span class="hljs-keyword">$this</span>-&gt;actingAs($admin, <span class="hljs-string">'sanctum'</span>)
        -&gt;postJson(<span class="hljs-string">"/api/v1/admin/tenants/{$tenant-&gt;id}/impersonate"</span>, [
            <span class="hljs-string">'reason'</span> =&gt; <span class="hljs-string">'Testing'</span>
        ]);
    
    $sessionId = $response-&gt;json(<span class="hljs-string">'data.session_id'</span>);
    
    <span class="hljs-comment">// Fast forward time</span>
    <span class="hljs-keyword">$this</span>-&gt;travel(<span class="hljs-number">2</span>)-&gt;hours();
    
    <span class="hljs-comment">// Session should be expired</span>
    <span class="hljs-keyword">$this</span>-&gt;assertDatabaseHas(<span class="hljs-string">'impersonation_sessions'</span>, [
        <span class="hljs-string">'id'</span> =&gt; $sessionId,
        <span class="hljs-string">'expired'</span> =&gt; <span class="hljs-keyword">true</span>
    ]);
});
</div></code></pre>
<h3 id="integration-tests">Integration Tests</h3>
<p><strong>Test Coverage Areas:</strong></p>
<ul>
<li>Tenant context propagation across requests</li>
<li>Event emission and listener execution</li>
<li>Cache invalidation on tenant updates</li>
<li>Database transaction rollbacks preserve tenant isolation</li>
<li>Queue jobs maintain tenant context</li>
</ul>
<p><strong>Test Examples:</strong></p>
<pre class="hljs"><code><div>test(<span class="hljs-string">'tenant context propagates to queued jobs'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant = Tenant::factory()-&gt;create();
    TenantContext::set($tenant);
    
    dispatch(<span class="hljs-keyword">new</span> ProcessTenantDataJob());
    
    <span class="hljs-comment">// Verify job runs with correct tenant context</span>
    Bus::assertDispatched(ProcessTenantDataJob::class, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($job)</span> <span class="hljs-title">use</span> <span class="hljs-params">($tenant)</span> </span>{
        <span class="hljs-keyword">return</span> $job-&gt;tenantId === $tenant-&gt;id;
    });
});

test(<span class="hljs-string">'TenantCreatedEvent triggers default data initialization'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    Event::fake([TenantCreatedEvent::class]);
    
    $tenant = Tenant::factory()-&gt;create();
    
    Event::assertDispatched(TenantCreatedEvent::class, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($event)</span> <span class="hljs-title">use</span> <span class="hljs-params">($tenant)</span> </span>{
        <span class="hljs-keyword">return</span> $event-&gt;tenant-&gt;id === $tenant-&gt;id;
    });
});
</div></code></pre>
<h3 id="performance-tests">Performance Tests</h3>
<p><strong>Test Coverage Areas:</strong></p>
<ul>
<li>Tenant resolution time under load</li>
<li>Cache hit rates for tenant context</li>
<li>Query count with tenant scoping</li>
<li>Concurrent tenant access patterns</li>
</ul>
<p><strong>Test Examples:</strong></p>
<pre class="hljs"><code><div>test(<span class="hljs-string">'tenant resolution completes in under 100ms'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant = Tenant::factory()-&gt;create();
    
    $iterations = <span class="hljs-number">100</span>;
    $times = [];
    
    <span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; $iterations; $i++) {
        $start = microtime(<span class="hljs-keyword">true</span>);
        $resolved = TenantResolver::resolveFromDomain($tenant-&gt;domain);
        $times[] = (microtime(<span class="hljs-keyword">true</span>) - $start) * <span class="hljs-number">1000</span>; <span class="hljs-comment">// Convert to ms</span>
    }
    
    $average = array_sum($times) / count($times);
    expect($average)-&gt;toBeLessThan(<span class="hljs-number">100</span>);
});

test(<span class="hljs-string">'tenant context uses cache to reduce queries'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $tenant = Tenant::factory()-&gt;create();
    
    <span class="hljs-comment">// First access - should query database</span>
    DB::enableQueryLog();
    TenantContext::get();
    $firstCallQueries = count(DB::getQueryLog());
    DB::flushQueryLog();
    
    <span class="hljs-comment">// Second access - should use cache</span>
    TenantContext::get();
    $secondCallQueries = count(DB::getQueryLog());
    
    expect($secondCallQueries)-&gt;toBe(<span class="hljs-number">0</span>); <span class="hljs-comment">// No queries, used cache</span>
});
</div></code></pre>
<hr>
<h2 id="dependencies">Dependencies</h2>
<h3 id="feature-module-dependencies">Feature Module Dependencies</h3>
<p><strong>Mandatory Dependencies:</strong></p>
<ul>
<li><strong>None</strong> - This is a foundational feature module with zero dependencies on other feature modules</li>
</ul>
<p><strong>Optional Dependencies:</strong></p>
<ul>
<li><strong>None</strong> - Other feature modules depend on this one, not vice versa</li>
</ul>
<h3 id="external-package-dependencies">External Package Dependencies</h3>
<table>
<thead>
<tr>
<th>Package</th>
<th>Version</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>laravel/framework</code></td>
<td>^12.0</td>
<td>Core framework</td>
</tr>
<tr>
<td><code>illuminate/database</code></td>
<td>^12.0</td>
<td>Database ORM</td>
</tr>
<tr>
<td><code>illuminate/cache</code></td>
<td>^12.0</td>
<td>Caching layer</td>
</tr>
<tr>
<td><code>illuminate/support</code></td>
<td>^12.0</td>
<td>Helper utilities</td>
</tr>
</tbody>
</table>
<h3 id="infrastructure-dependencies">Infrastructure Dependencies</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Requirement</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Database</strong></td>
<td>PostgreSQL 14+ or MySQL 8.0+</td>
<td>Tenant data storage</td>
</tr>
<tr>
<td><strong>Cache</strong></td>
<td>Redis 6+ or Memcached 1.6+</td>
<td>Tenant context caching</td>
</tr>
<tr>
<td><strong>PHP Extensions</strong></td>
<td><code>ext-redis</code>, <code>ext-pdo</code>, <code>ext-json</code></td>
<td>Runtime dependencies</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="feature-module-structure">Feature Module Structure</h2>
<h3 id="directory-structure-in-monorepo">Directory Structure (in Monorepo)</h3>
<pre class="hljs"><code><div>packages/multitenancy/
├── src/
│   ├── Actions/
│   │   ├── CreateTenantAction.php
│   │   ├── UpdateTenantAction.php
│   │   ├── SuspendTenantAction.php
│   │   ├── ActivateTenantAction.php
│   │   ├── ArchiveTenantAction.php
│   │   └── StartImpersonationAction.php
│   ├── Contracts/
│   │   ├── TenantRepositoryContract.php
│   │   ├── TenantResolverContract.php
│   │   └── ImpersonationServiceContract.php
│   ├── Events/
│   │   ├── TenantCreatedEvent.php
│   │   ├── TenantUpdatedEvent.php
│   │   ├── TenantSuspendedEvent.php
│   │   ├── TenantActivatedEvent.php
│   │   ├── TenantArchivedEvent.php
│   │   ├── TenantDeletedEvent.php
│   │   ├── TenantImpersonationStartedEvent.php
│   │   └── TenantImpersonationEndedEvent.php
│   ├── Http/
│   │   ├── Controllers/
│   │   │   └── TenantController.php
│   │   ├── Requests/
│   │   │   ├── CreateTenantRequest.php
│   │   │   ├── UpdateTenantRequest.php
│   │   │   └── ImpersonateTenantRequest.php
│   │   ├── Resources/
│   │   │   └── TenantResource.php
│   │   └── Middleware/
│   │       ├── IdentifyTenant.php
│   │       └── EnsureTenantActive.php
│   ├── Models/
│   │   ├── Tenant.php
│   │   └── ImpersonationSession.php
│   ├── Repositories/
│   │   └── TenantRepository.php
│   ├── Services/
│   │   ├── TenantResolver.php
│   │   ├── TenantContext.php
│   │   └── ImpersonationService.php
│   ├── Traits/
│   │   └── BelongsToTenant.php
│   ├── Enums/
│   │   └── TenantStatus.php
│   └── MultitenancyServiceProvider.php
├── tests/
│   ├── Feature/
│   │   ├── TenantCrudTest.php
│   │   ├── TenantImpersonationTest.php
│   │   └── TenantIsolationTest.php
│   └── Unit/
│       ├── TenantModelTest.php
│       ├── BelongsToTenantTraitTest.php
│       └── TenantResolverTest.php
├── database/
│   ├── migrations/
│   │   ├── 0001_01_01_000000_create_tenants_table.php
│   │   └── 0001_01_01_000001_create_impersonation_sessions_table.php
│   └── factories/
│       └── TenantFactory.php
├── config/
│   └── multitenancy.php
├── routes/
│   └── api.php
├── composer.json
└── README.md
</div></code></pre>
<h3 id="key-classes">Key Classes</h3>
<p><strong>Tenant Model:</strong></p>
<pre class="hljs"><code><div><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Azaharizaman</span>\<span class="hljs-title">Erp</span>\<span class="hljs-title">Multitenancy</span>\<span class="hljs-title">Models</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">SoftDeletes</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Concerns</span>\<span class="hljs-title">HasUuids</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tenant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">HasUuids</span>, <span class="hljs-title">SoftDeletes</span>;
    
    <span class="hljs-keyword">protected</span> $fillable = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'domain'</span>, <span class="hljs-string">'status'</span>, <span class="hljs-string">'configuration'</span>];
    
    <span class="hljs-keyword">protected</span> $casts = [
        <span class="hljs-string">'status'</span> =&gt; TenantStatus::class,
        <span class="hljs-string">'configuration'</span> =&gt; <span class="hljs-string">'encrypted:array'</span>,
    ];
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isActive</span><span class="hljs-params">()</span>: <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;status === TenantStatus::ACTIVE;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isSuspended</span><span class="hljs-params">()</span>: <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;status === TenantStatus::SUSPENDED;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isArchived</span><span class="hljs-params">()</span>: <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;status === TenantStatus::ARCHIVED;
    }
}
</div></code></pre>
<p><strong>BelongsToTenant Trait:</strong></p>
<pre class="hljs"><code><div><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Azaharizaman</span>\<span class="hljs-title">Erp</span>\<span class="hljs-title">Multitenancy</span>\<span class="hljs-title">Traits</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Builder</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Azaharizaman</span>\<span class="hljs-title">Erp</span>\<span class="hljs-title">Multitenancy</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">TenantContext</span>;

<span class="hljs-keyword">trait</span> BelongsToTenant
{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bootBelongsToTenant</span><span class="hljs-params">()</span>: <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-keyword">static</span>::creating(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($model)</span> </span>{
            <span class="hljs-keyword">if</span> (! $model-&gt;tenant_id) {
                $model-&gt;tenant_id = TenantContext::getId();
            }
        });
        
        <span class="hljs-keyword">static</span>::addGlobalScope(<span class="hljs-string">'tenant'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Builder $builder)</span> </span>{
            $builder-&gt;where(<span class="hljs-string">'tenant_id'</span>, TenantContext::getId());
        });
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tenant</span><span class="hljs-params">()</span>: <span class="hljs-title">BelongsTo</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;belongsTo(Tenant::class);
    }
}
</div></code></pre>
<hr>
<h2 id="migration-path">Migration Path</h2>
<h3 id="from-single-tenant-to-multi-tenant">From Single-Tenant to Multi-Tenant</h3>
<p>If migrating an existing single-tenant Laravel application to use this multi-tenancy feature module:</p>
<p><strong>Step 1: Install Package</strong></p>
<pre class="hljs"><code><div>composer require azaharizaman/erp-multitenancy
</div></code></pre>
<p><strong>Step 2: Run Migrations</strong></p>
<pre class="hljs"><code><div>php artisan migrate
</div></code></pre>
<p><strong>Step 3: Add tenant_id to Models</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Add migration to existing tables</span>
Schema::table(<span class="hljs-string">'users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Blueprint $table)</span> </span>{
    $table-&gt;uuid(<span class="hljs-string">'tenant_id'</span>)-&gt;nullable()-&gt;after(<span class="hljs-string">'id'</span>);
    $table-&gt;foreign(<span class="hljs-string">'tenant_id'</span>)-&gt;references(<span class="hljs-string">'id'</span>)-&gt;on(<span class="hljs-string">'tenants'</span>)-&gt;onDelete(<span class="hljs-string">'cascade'</span>);
    $table-&gt;index(<span class="hljs-string">'tenant_id'</span>);
});

<span class="hljs-comment">// Update models to use trait</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Authenticatable</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">BelongsToTenant</span>;
}
</div></code></pre>
<p><strong>Step 4: Create Default Tenant</strong></p>
<pre class="hljs"><code><div>php artisan tenant:create <span class="hljs-string">"Default Tenant"</span> --domain=default
</div></code></pre>
<p><strong>Step 5: Associate Existing Data</strong></p>
<pre class="hljs"><code><div>php artisan tenant:migrate-data {tenant_id}
</div></code></pre>
<hr>
<h2 id="success-metrics">Success Metrics</h2>
<h3 id="technical-metrics">Technical Metrics</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Measurement Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tenant Resolution Time</td>
<td>&lt; 100ms average</td>
<td>Performance monitoring</td>
</tr>
<tr>
<td>Cache Hit Rate</td>
<td>&gt; 95%</td>
<td>Redis metrics</td>
</tr>
<tr>
<td>Cross-Tenant Access Attempts</td>
<td>0 successful</td>
<td>Security audit logs</td>
</tr>
<tr>
<td>Test Coverage</td>
<td>100%</td>
<td>Pest coverage report</td>
</tr>
</tbody>
</table>
<h3 id="business-metrics">Business Metrics</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Measurement Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Active Tenants Supported</td>
<td>1,000+</td>
<td>Database count</td>
</tr>
<tr>
<td>Tenant Creation Time</td>
<td>&lt; 30 seconds</td>
<td>API response time</td>
</tr>
<tr>
<td>System Uptime per Tenant</td>
<td>99.9%</td>
<td>Monitoring</td>
</tr>
<tr>
<td>Support Impersonation Usage</td>
<td>&lt; 5% of tenants/month</td>
<td>Audit logs</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="assumptions--constraints">Assumptions &amp; Constraints</h2>
<h3 id="assumptions">Assumptions</h3>
<ol>
<li><strong>Database Performance:</strong> PostgreSQL or MySQL can handle thousands of concurrent tenant queries with proper indexing</li>
<li><strong>Cache Availability:</strong> Redis or Memcached is available and configured for high availability</li>
<li><strong>Subdomain Routing:</strong> DNS configuration allows wildcard subdomain routing (*.yourdomain.com)</li>
<li><strong>User Count per Tenant:</strong> Average tenant has 10-50 users (affects cache sizing)</li>
<li><strong>Tenant Growth:</strong> 10-20% monthly growth in tenant count</li>
</ol>
<h3 id="constraints">Constraints</h3>
<ol>
<li><strong>Single Database:</strong> All tenants share the same database (no per-tenant databases)</li>
<li><strong>Laravel Framework:</strong> Must use Laravel v12.x (not compatible with older versions)</li>
<li><strong>PHP Version:</strong> Requires PHP 8.2+ for enum and type system support</li>
<li><strong>Cache Requirement:</strong> Redis/Memcached is mandatory, not optional</li>
<li><strong>Migration Complexity:</strong> Adding multi-tenancy to existing apps requires careful data migration</li>
</ol>
<hr>
<h2 id="monorepo-integration">Monorepo Integration</h2>
<h3 id="development">Development</h3>
<p>During development in the monorepo:</p>
<ol>
<li><strong>Location:</strong> Lives in <code>/packages/multitenancy/</code> directory</li>
<li><strong>Local Requirement:</strong> Main app uses Composer path repository:<pre class="hljs"><code><div>{
    <span class="hljs-attr">"repositories"</span>: [
        {
            <span class="hljs-attr">"type"</span>: <span class="hljs-string">"path"</span>,
            <span class="hljs-attr">"url"</span>: <span class="hljs-string">"../../packages/*"</span>
        }
    ],
    <span class="hljs-attr">"require"</span>: {
        <span class="hljs-attr">"azaharizaman/erp-multitenancy"</span>: <span class="hljs-string">"dev-main"</span>
    }
}
</div></code></pre>
</li>
<li><strong>Development Flow:</strong>
<ul>
<li>Edit code in <code>/packages/multitenancy/</code></li>
<li>Changes immediately reflected in main app</li>
<li>Run tests: <code>./vendor/bin/pest packages/multitenancy/tests</code></li>
<li>Commit changes to monorepo</li>
</ul>
</li>
</ol>
<h3 id="release-v10">Release (v1.0)</h3>
<p>When releasing version 1.0:</p>
<ol>
<li><strong>Tagging:</strong> Tag monorepo with version (e.g., <code>v1.0.0</code>)</li>
<li><strong>Packagist Publication:</strong> Publish <code>azaharizaman/erp-multitenancy</code> to Packagist</li>
<li><strong>Independent Installation:</strong> External Laravel apps can install:<pre class="hljs"><code><div>composer require azaharizaman/erp-multitenancy
</div></code></pre>
</li>
<li><strong>Versioning:</strong> Package follows SemVer with monorepo release</li>
</ol>
<hr>
<h2 id="references">References</h2>
<ul>
<li>Master PRD: <a href="../PRD01-MVP.md">../PRD01-MVP.md</a></li>
<li>Monorepo Strategy: <a href="../PRD01-MVP.md#c1-core-architectural-strategy-the-monorepo">../PRD01-MVP.md#c1-core-architectural-strategy-the-monorepo</a></li>
<li>Feature Module Independence: <a href="../PRD01-MVP.md#d22-feature-module-independence-requirements">../PRD01-MVP.md#d22-feature-module-independence-requirements</a></li>
<li>Architecture Documentation: <a href="../../architecture/">../../architecture/</a></li>
<li>Coding Guidelines: <a href="../../CODING_GUIDELINES.md">../../CODING_GUIDELINES.md</a></li>
<li>GitHub Copilot Instructions: <a href="../../.github/copilot-instructions.md">../../.github/copilot-instructions.md</a></li>
</ul>
<hr>
<h2 id="next-steps">Next Steps</h2>
<ol>
<li>✅ Review and approve this Sub-PRD</li>
<li>⏳ Create implementation plan: <code>PLAN01-implement-multitenancy.md</code> in <code>/docs/plan/</code></li>
<li>⏳ Break down into GitHub issues using <code>.github/prompts/create-issue-from-implementation-plan.prompt.md</code></li>
<li>⏳ Assign to <strong>MILESTONE 1</strong> (Nov 30, 2025)</li>
<li>⏳ Set up feature module structure in <code>/packages/multitenancy/</code></li>
<li>⏳ Implement database migrations for tenants table</li>
<li>⏳ Develop Tenant model and repository</li>
<li>⏳ Create BelongsToTenant trait and global scope</li>
<li>⏳ Implement tenant resolution middleware</li>
<li>⏳ Build tenant management API endpoints</li>
<li>⏳ Add impersonation functionality with audit</li>
<li>⏳ Write comprehensive tests (unit, feature, integration)</li>
<li>⏳ Generate API documentation (OpenAPI/Swagger)</li>
<li>⏳ Code review and QA testing</li>
</ol>
<hr>
<p><strong>Document Status:</strong> Draft - Pending Review<br>
<strong>Maintained By:</strong> Laravel ERP Development Team<br>
<strong>Last Updated:</strong> November 11, 2025</p>

</body>
</html>
